#!/bin/bash

# ============================================
# DELETAR M√öLTIPLOS REPOSIT√ìRIOS
# ============================================

echo "=== DELETADOR EM MASSA DE REPOSIT√ìRIOS ==="
echo ""

# Verificar autentica√ß√£o
if ! gh auth status &> /dev/null; then
    echo "ERRO: Execute 'gh auth login' primeiro!"
    exit 1
fi

# Obter seu username
MEU_USER=$(gh api user --jq '.login')
echo "Usu√°rio: $MEU_USER"
echo ""

# Arquivo com lista de reposit√≥rios para deletar
LISTA="repos_para_deletar.txt"

# Verificar se o arquivo existe
if [ ! -f "$LISTA" ]; then
    echo "‚ùå Arquivo '$LISTA' n√£o encontrado."
    echo ""
    echo "Crie um arquivo '$LISTA' com a lista de reposit√≥rios."
    echo "Um reposit√≥rio por linha, formato: usuario/repositorio"
    echo ""
    echo "Exemplo do conte√∫do:"
    echo "$MEU_USER/teste-1"
    echo "$MEU_USER/projeto-antigo"
    echo "$MEU_USER/exemplo"
    exit 1
fi

# Mostrar lista
echo "üìã Lista de reposit√≥rios para deletar:"
echo "----------------------------------------"
cat "$LISTA" | nl -w2 -s'. '
echo "----------------------------------------"
TOTAL=$(wc -l < "$LISTA")
echo "Total: $TOTAL reposit√≥rios"
echo ""

# Confirma√ß√£o
echo "‚ö†Ô∏è  ‚ö†Ô∏è  ATEN√á√ÉO: OPERA√á√ÉO IRREVERS√çVEL! ‚ö†Ô∏è  ‚ö†Ô∏è"
echo "Todos estes reposit√≥rios ser√£o DELETADOS PERMANENTEMENTE."
echo ""

read -p "Continuar? (s/n): " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Ss]$ ]]; then
    echo "‚ùå Opera√ß√£o cancelada."
    exit 0
fi

# Confirma√ß√£o FINAL
echo "Digite 'CONFIRMAR-DELETAR-TUDO' para prosseguir:"
read CONFIRMACAO_FINAL

if [ "$CONFIRMACAO_FINAL" != "CONFIRMAR-DELETAR-TUDO" ]; then
    echo "‚ùå Opera√ß√£o cancelada (confirma√ß√£o incorreta)."
    exit 0
fi

# Processar cada reposit√≥rio
echo ""
echo "üîÑ Iniciando dele√ß√£o..."
echo ""

SUCESSO=0
FALHA=0

while IFS= read -r REPO || [ -n "$REPO" ]; do
    # Pular linhas vazias
    [[ -z "$REPO" ]] && continue
    
    echo "--------------------------------------------------"
    echo "Processando: $REPO"
    
    # Verificar se o reposit√≥rio existe
    if gh repo view "$REPO" &> /dev/null; then
        echo "‚úÖ Reposit√≥rio encontrado"
        
        # Deletar
        if gh repo delete "$REPO" --yes; then
            echo "‚úÖ DELETADO: $REPO"
            ((SUCESSO++))
        else
            echo "‚ùå Falha ao deletar: $REPO"
            ((FALHA++))
        fi
    else
        echo "‚ö†Ô∏è  Reposit√≥rio n√£o encontrado ou sem permiss√£o: $REPO"
        ((FALHA++))
    fi
    
    # Aguardar para n√£o sobrecarregar a API
    sleep 1
    
done < "$LISTA"

# Relat√≥rio final
echo ""
echo "========================================"
echo "üìä RELAT√ìRIO FINAL"
echo "========================================"
echo "Total processado: $TOTAL"
echo "‚úÖ Sucesso: $SUCESSO"
echo "‚ùå Falhas: $FALHA"
echo "========================================"

# Salvar log
LOG="delecao_$(date +%Y%m%d_%H%M%S).log"
{
    echo "Data: $(date)"
    echo "Usu√°rio: $MEU_USER"
    echo "Total: $TOTAL"
    echo "Sucesso: $SUCESSO"
    echo "Falhas: $FALHA"
    echo ""
    echo "Reposit√≥rios processados:"
    cat "$LISTA"
} > "$LOG"

echo "Log salvo em: $LOG"
